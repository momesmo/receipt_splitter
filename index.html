<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Receipt Cost Splitter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .config-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
            position: relative;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .config-section h3 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .config-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .config-input label {
            font-weight: bold;
            color: #333;
        }
        
        .config-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .input-table,
        .running-total-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            box-sizing: border-box;
        }
        
        .input-table th,
        .input-table td,
        .running-total-table th,
        .running-total-table td {
            padding: 10px;
            font-size: 15px;
            font-family: inherit;
            box-sizing: border-box;
            border-bottom: 1px solid #eee;
            text-align: left;
            vertical-align: middle;
        }
        
        .input-table th,
        .running-total-table th {
            background: #e9ecef;
            color: #666;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        .running-total-table th {
            background: #ffc107;
            color: #856404;
            border-bottom: 2px solid #ffc107;
        }
        
        .input-table td:last-child,
        .running-total-table td:last-child {
            text-align: left;
        }
        
        .input-table td,
        .running-total-table td {
            background: #fff;
        }
        
        .input-table tr:last-child td,
        .running-total-table tr:last-child td {
            border-bottom: none;
            font-weight: bold;
            background: #f8f9fa;
        }
        
        .input-table button {
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .input-table button:hover {
            background: #c82333;
        }
        
        .add-button {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .add-button:hover {
            background: #218838;
        }
        
        .tax-section {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            align-items: center;
            justify-content: center;
        }
        
        .amount-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0;
        }
        
        .amount-input label {
            font-weight: bold;
        }
        
        .amount-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }
        
        .summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .person-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .person-summary h3 {
            margin-top: 0;
            color: #007bff;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
        }
        
        .summary-row.total {
            border-top: 2px solid #007bff;
            font-weight: bold;
            font-size: 18px;
            color: #007bff;
        }
        
        .export-section {
            margin-top: 30px;
            text-align: center;
        }
        
        .export-button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .export-button:hover {
            background: #0056b3;
        }
        
        .running-total-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .running-total-section h3 {
            margin-top: 0;
            color: #856404;
        }

        .running-total-table th {
            width: 25%;
        }

        .input-table th:nth-child(1) { width: 25%; } /* Item Description */
        .input-table th:nth-child(2) { width: 15%; } /* Cost ($) */
        .input-table th:nth-child(3) { width: 20%; } /* Expense To */
        .input-table th:nth-child(4) { width: 30%; } /* Custom Split */
        .input-table th:nth-child(5) { width: 10%; } /* Action */
        
        .input-table input, .input-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            box-sizing: border-box;
        }
        .input-table .item-cost {
            max-width: 100px;
            min-width: 60px;
            width: 100%;
        }
        .person-config-flex {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .person-config-flex label {
            margin-bottom: 0;
        }
        .person-config-flex input {
            flex: 1 1 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Grocery Receipt Cost Splitter</h1>
        
        <div class="config-section">
            <div class="config-header">
                <h3>Configuration</h3>
                <button id="add-person-btn" type="button" onclick="addPerson()">+ Add Person</button>
            </div>
            <div id="people-config-list">
                <!-- People config list will be dynamically populated -->
            </div>
        </div>
        
        <div class="input-section">
            <h3>Add Items</h3>
            <table class="input-table">
                <thead>
                    <tr>
                        <th>Item Description</th>
                        <th>Cost ($)</th>
                        <th>Expense To</th>
                        <th>Custom Split</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="items-container">
                    <!-- Items will be populated dynamically -->
                </tbody>
            </table>
            <button class="add-button" onclick="addItem()">+ Add Another Item</button>
        </div>
        
        <div class="tax-section">
            <div class="amount-input">
                <label for="tax-amount">Total Tax Amount: $</label>
                <input type="number" id="tax-amount" step="0.01" placeholder="0.00" oninput="calculateSummary()">
            </div>
            <div class="amount-input">
                <label for="tip-amount">Total Tip Amount: $</label>
                <input type="number" id="tip-amount" step="0.01" placeholder="0.00" oninput="calculateSummary()">
            </div>
        </div>
        
        <div class="summary">
            <div class="person-summary">
                <h3 id="person1-title">Person 1</h3>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="person1-subtotal">$0.00</span>
                </div>
                <div class="summary-row">
                    <span>Tax Share:</span>
                    <span id="person1-tax">$0.00</span>
                </div>
                <div class="summary-row">
                    <span>Tip Share:</span>
                    <span id="person1-tip">$0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="person1-total">$0.00</span>
                </div>
            </div>
            
            <div class="person-summary">
                <h3 id="person2-title">Person 2</h3>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="person2-subtotal">$0.00</span>
                </div>
                <div class="summary-row">
                    <span>Tax Share:</span>
                    <span id="person2-tax">$0.00</span>
                </div>
                <div class="summary-row">
                    <span>Tip Share:</span>
                    <span id="person2-tip">$0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="person2-total">$0.00</span>
                </div>
            </div>
        </div>
        
        <div class="running-total-section">
            <h3>Running Total</h3>
            <table class="running-total-table">
                <thead>
                    <tr>
                        <th>Item Description</th>
                        <th>Cost ($)</th>
                        <th>Expense To</th>
                        <th>Share</th>
                    </tr>
                </thead>
                <tbody id="running-total-container">
                    <!-- Items will be populated dynamically -->
                </tbody>
            </table>
        </div>
        
        <div class="export-section">
            <button class="export-button" onclick="exportToCSV()">Export to CSV</button>
            <p><small>Click to download a CSV file that you can open in Excel</small></p>
        </div>
    </div>

    <script>
        // Configuration variables
        let people = [
            { id: crypto.randomUUID ? crypto.randomUUID() : 'p1', name: 'Person 1' },
            { id: crypto.randomUUID ? crypto.randomUUID() : 'p2', name: 'Person 2' }
        ];
        
        function updatePersonNames() {
            // Preserve all current custom split values for each row and person id
            const customSplitPreserve = [];
            document.querySelectorAll('.input-row').forEach((row, rowIdx) => {
                const payerSelect = row.querySelector('.item-payer');
                if (payerSelect && payerSelect.value === 'Custom') {
                    const customCell = row.querySelector('.custom-split-cell');
                    if (customCell) {
                        const oldInputs = customCell.querySelectorAll('.custom-split-person');
                        const oldValues = {};
                        oldInputs.forEach(inp => {
                            oldValues[inp.getAttribute('data-person-id')] = inp.value;
                        });
                        let typeSel = customCell.querySelector('.custom-split-type');
                        let typeValue = typeSel ? typeSel.value : 'percent';
                        customSplitPreserve[rowIdx] = { oldValues, typeValue };
                    }
                }
            });

            // Update people array from config inputs
            const personInputs = document.querySelectorAll('[id^="person-"][id$="-name"]');
            people.forEach((p, i) => {
                p.name = personInputs[i] ? personInputs[i].value || personInputs[i].placeholder || "Person" : p.name;
            });

            // Show/hide delete buttons
            const deleteBtns = document.querySelectorAll('.delete-person-btn');
            if (people.length > 2) {
                deleteBtns.forEach(btn => btn.style.display = 'inline-block');
            } else {
                deleteBtns.forEach(btn => btn.style.display = 'none');
            }

            // Update summary titles
            people.forEach((p, idx) => {
                const title = document.getElementById(`person${idx+1}-title`);
                if (title) title.textContent = p.name;
            });

            // Update all select options, preserving selection by value only
            const selectElements = document.querySelectorAll('.item-payer');
            selectElements.forEach(select => {
                const prevValue = select.value;
                let optionsHtml = people.map((p, idx) => `<option value="${p.id}">${p.name}</option>`).join('');
                optionsHtml += `<option value="Split">Split Evenly</option><option value="Custom">Custom Split</option>`;
                select.innerHTML = optionsHtml;
                // Try to restore by value, fallback to error state if not found
                if ([...people.map(p => p.id), 'Split', 'Custom'].includes(prevValue)) {
                    select.value = prevValue;
                    select.style.borderColor = '#ddd';
                } else {
                    select.selectedIndex = -1;
                    select.style.borderColor = 'red';
                }
            });

            // For all rows with Custom Split, update the custom split UI and validation, preserving values for existing people
            document.querySelectorAll('.input-row').forEach((row, rowIdx) => {
                const payerSelect = row.querySelector('.item-payer');
                if (payerSelect && payerSelect.value === 'Custom') {
                    const customCell = row.querySelector('.custom-split-cell');
                    // Use preserved values if available
                    let oldValues = {}, typeValue = 'percent';
                    if (customSplitPreserve[rowIdx]) {
                        oldValues = customSplitPreserve[rowIdx].oldValues;
                        typeValue = customSplitPreserve[rowIdx].typeValue;
                    }
                    // Rebuild the custom split UI for all people
                    let customInputsHtml = people.map((p, idx) =>
                        `<input type="number" class="custom-split-person" data-person-idx="${idx}" data-person-id="${p.id}" placeholder="${p.name} % or $" min="0" style="width:${Math.max(100/people.length-2,20)}%; display:inline-block; margin-right:2px;" onchange="calculateSummary()" oninput="validateCustomSplit(this)" value="${oldValues[p.id] || ''}">`
                    ).join('');
                    customInputsHtml += `<select class="custom-split-type" style="width:100%; margin-top:2px;" onchange="calculateSummary(); validateCustomSplit(this)">
                        <option value="percent"${typeValue==='percent'?' selected':''}>%</option>
                        <option value="dollar"${typeValue==='dollar'?' selected':''}>$</option>
                    </select>`;
                    if (customCell) customCell.innerHTML = customInputsHtml;
                    // Validate all custom split inputs in this row
                    const customInputs = row.querySelectorAll('.custom-split-person');
                    customInputs.forEach(input => validateCustomSplit(input));
                }
            });

            calculateSummary();
        }
        
        function addPerson() {
            people.push({ id: generatePersonId(), name: `Person ${people.length + 1}` });
            rebuildPeopleConfigList();
            updatePersonNames();
        }
        
        function deletePerson(idx) {
            if (people.length <= 2) return; // Always keep at least 2 people
            people.splice(idx, 1);
            rebuildPeopleConfigList();
            updatePersonNames();
        }
        
        function rebuildPeopleConfigList() {
            const peopleConfigList = document.getElementById('people-config-list');
            peopleConfigList.innerHTML = '';
            for (let i = 0; i < people.length; i += 2) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'config-row';
                for (let j = 0; j < 2 && (i + j) < people.length; j++) {
                    const idx = i + j;
                    const inputDiv = document.createElement('div');
                    inputDiv.className = 'config-input';
                    inputDiv.innerHTML = `
                        <div class="person-config-flex">
                            <label for="person-${idx}-name">Person ${idx+1} Name:</label>
                            <input type="text" id="person-${idx}-name" value="${people[idx].name}" onchange="updatePersonNames()">
                            <button type="button" class="delete-person-btn" style="${people.length > 2 ? '' : 'display:none'}; margin-left:8px;" onclick="deletePerson(${idx})">Delete</button>
                        </div>
                    `;
                    rowDiv.appendChild(inputDiv);
                }
                peopleConfigList.appendChild(rowDiv);
            }
        }
        
        function addItem() {
            const container = document.getElementById('items-container');
            const newRow = document.createElement('tr');
            newRow.className = 'input-row';
            // Generate options for all people
            let optionsHtml = people.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            optionsHtml += `<option value="Split">Split Evenly</option><option value="Custom">Custom Split</option>`;
            newRow.innerHTML = `
                <td><input type="text" placeholder="Enter item name" class="item-name"></td>
                <td><input type="number" step="0.01" placeholder="0.00" class="item-cost" oninput="calculateSummary()"></td>
                <td>
                    <select class="item-payer" onchange="handlePayerChange(this); calculateSummary(); validateCustomSplit(this)" oninput="resetPayerBorder(this)">
                        ${optionsHtml}
                    </select>
                </td>
                <td class="custom-split-cell"></td>
                <td><button onclick="removeItem(this)">Remove</button></td>
            `;
            container.appendChild(newRow);
            addEnterKeyListener(newRow);
        }
        
        function removeItem(button) {
            button.closest('tr').remove();
            calculateSummary();
        }
        
        // Helper to split an amount into two shares, assigning the extra cent to the second share
        function splitAmount(amount) {
            const first = Math.floor(amount * 100 / 2) / 100;
            const second = Math.round((amount - first) * 100) / 100;
            return [first, second];
        }

        function calculateSummary() {
            // Initialize subtotals for each person
            let subtotals = people.map(() => 0);
            const items = document.querySelectorAll('.input-row');
            items.forEach(item => {
                const cost = parseFloat(item.querySelector('.item-cost').value) || 0;
                const payer = item.querySelector('.item-payer').value;
                if (people.find(p => p.id === payer)) {
                    // Assign full cost to selected person
                    const idx = people.findIndex(p => p.id === payer);
                    subtotals[idx] += cost;
                } else if (payer === 'Split') {
                    // Split evenly among all people
                    const evenShare = Math.floor((cost / people.length) * 100) / 100;
                    let distributed = evenShare * people.length;
                    let remainder = Math.round((cost - distributed) * 100) / 100;
                    for (let i = 0; i < people.length; i++) {
                        subtotals[i] += evenShare;
                    }
                    // Assign remainder to the last person
                    if (remainder !== 0) {
                        subtotals[people.length - 1] += remainder;
                    }
                } else if (payer === 'Custom') {
                    const row = item;
                    const customCell = row.querySelector('.custom-split-cell');
                    if (customCell) {
                        const typeSel = customCell.querySelector('.custom-split-type');
                        const customInputs = customCell.querySelectorAll('input');
                        if (typeSel && customInputs.length === people.length) {
                            const type = typeSel.value;
                            let shares = Array.from(customInputs).map(input => parseFloat(input.value) || 0);
                            if (type === 'percent') {
                                const percentSum = shares.reduce((a, b) => a + b, 0);
                                if (Math.abs(percentSum - 100) < 0.01) {
                                    for (let i = 0; i < people.length; i++) {
                                        subtotals[i] += cost * (shares[i] / 100);
                                    }
                                }
                            } else if (type === 'dollar') {
                                const dollarSum = shares.reduce((a, b) => a + b, 0);
                                if (Math.abs(dollarSum - cost) < 0.01) {
                                    for (let i = 0; i < people.length; i++) {
                                        subtotals[i] += shares[i];
                                    }
                                }
                            }
                        }
                    }
                }
            });
            // Round subtotals
            subtotals = subtotals.map(x => Math.round(x * 100) / 100);
            const totalSubtotal = subtotals.reduce((a, b) => a + b, 0);
            const taxAmount = parseFloat(document.getElementById('tax-amount').value) || 0;
            const tipAmount = parseFloat(document.getElementById('tip-amount').value) || 0;
            // Calculate tax shares
            let taxShares = people.map(() => 0);
            let tipShares = people.map(() => 0);
            if (totalSubtotal > 0) {
                let distributed = 0;
                for (let i = 0; i < people.length - 1; i++) {
                    taxShares[i] = Math.round((subtotals[i] / totalSubtotal * taxAmount) * 100) / 100;
                    distributed += taxShares[i];
                }
                taxShares[people.length - 1] = Math.round((taxAmount - distributed) * 100) / 100;
            }
            if (totalSubtotal > 0) {
                let distributed = 0;
                for (let i = 0; i < people.length - 1; i++) {
                    tipShares[i] = Math.round((subtotals[i] / totalSubtotal * tipAmount) * 100) / 100;
                    distributed += tipShares[i];
                }
                tipShares[people.length - 1] = Math.round((tipAmount - distributed) * 100) / 100;
            }
            // Update summary section
            const summaryDiv = document.querySelector('.summary');
            summaryDiv.innerHTML = people.map((p, idx) => `
                <div class="person-summary">
                    <h3 id="person${idx+1}-title">${p.name}</h3>
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="person${idx+1}-subtotal">$${subtotals[idx].toFixed(2)}</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax Share:</span>
                        <span id="person${idx+1}-tax">$${taxShares[idx].toFixed(2)}</span>
                    </div>
                    <div class="summary-row">
                        <span>Tip Share:</span>
                        <span id="person${idx+1}-tip">$${tipShares[idx].toFixed(2)}</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="person${idx+1}-total">$${(subtotals[idx] + taxShares[idx] + tipShares[idx]).toFixed(2)}</span>
                    </div>
                </div>
            `).join('');
            // Update running total
            updateRunningTotal(subtotals, taxShares, tipShares);
        }
        
        function updateRunningTotal(subtotals, taxShares, tipShares) {
            const container = document.getElementById('running-total-container');
            container.innerHTML = '';
            const items = document.querySelectorAll('.input-row');
            let totalCost = 0;
            items.forEach(item => {
                const name = item.querySelector('.item-name').value || 'Unnamed Item';
                const cost = parseFloat(item.querySelector('.item-cost').value) || 0;
                const payer = item.querySelector('.item-payer').value;
                let shares = people.map(() => 0);
                let shareText = '';
                let payerDisplay = payer;
                if (cost > 0) {
                    totalCost += cost;
                    if (people.find(p => p.id === payer)) {
                        shares[people.findIndex(p => p.id === payer)] = cost;
                        payerDisplay = people.find(p => p.id === payer).name;
                    } else if (payer === 'Split') {
                        const evenShare = Math.floor((cost / people.length) * 100) / 100;
                        let distributed = evenShare * people.length;
                        let remainder = Math.round((cost - distributed) * 100) / 100;
                        for (let i = 0; i < people.length; i++) {
                            shares[i] = evenShare;
                        }
                        if (remainder !== 0) {
                            shares[people.length - 1] += remainder;
                        }
                        payerDisplay = 'Split Evenly';
                    } else if (payer === 'Custom') {
                        const row = item;
                        const customCell = row.querySelector('.custom-split-cell');
                        if (customCell) {
                            const typeSel = customCell.querySelector('.custom-split-type');
                            const customInputs = customCell.querySelectorAll('input');
                            if (typeSel && customInputs.length === people.length) {
                                const type = typeSel.value;
                                let inputVals = Array.from(customInputs).map(input => parseFloat(input.value) || 0);
                                if (type === 'percent') {
                                    const percentSum = inputVals.reduce((a, b) => a + b, 0);
                                    if (Math.abs(percentSum - 100) < 0.01) {
                                        for (let i = 0; i < people.length; i++) {
                                            shares[i] = cost * (inputVals[i] / 100);
                                        }
                                    }
                                } else if (type === 'dollar') {
                                    const dollarSum = inputVals.reduce((a, b) => a + b, 0);
                                    if (Math.abs(dollarSum - cost) < 0.01) {
                                        for (let i = 0; i < people.length; i++) {
                                            shares[i] = inputVals[i];
                                        }
                                    }
                                }
                            }
                        }
                        payerDisplay = 'Custom Split';
                    }
                    shareText = people.map((p, idx) => `${p.name}: $${shares[idx].toFixed(2)}`).join('<br/>');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="item-name">${name}</td>
                        <td class="item-cost">$${cost.toFixed(2)}</td>
                        <td class="item-payer">${payerDisplay}</td>
                        <td class="item-share">${shareText}</td>
                    `;
                    container.appendChild(row);
                }
            });
            // Add tax row if there's tax
            const taxAmount = parseFloat(document.getElementById('tax-amount').value) || 0;
            if (taxAmount > 0) {
                const totalSubtotal = subtotals.reduce((a, b) => a + b, 0);
                let taxShareText = people.map((p, idx) => `${p.name}: $${taxShares[idx].toFixed(2)}`).join('<br/>');
                const taxRow = document.createElement('tr');
                taxRow.innerHTML = `
                    <td class="item-name">Tax</td>
                    <td class="item-cost">$${taxAmount.toFixed(2)}</td>
                    <td class="item-payer">Split by ratio</td>
                    <td class="item-share">${taxShareText}</td>
                `;
                container.appendChild(taxRow);
            }
            // Add tip row if there's tip
            const tipAmount = parseFloat(document.getElementById('tip-amount').value) || 0;
            if (tipAmount > 0) {
                const totalSubtotal = subtotals.reduce((a, b) => a + b, 0);
                let tipShareText = people.map((p, idx) => `${p.name}: $${tipShares[idx].toFixed(2)}`).join('<br/>');
                const tipRow = document.createElement('tr');
                tipRow.innerHTML = `
                    <td class="item-name">Tip</td>
                    <td class="item-cost">$${tipAmount.toFixed(2)}</td>
                    <td class="item-payer">Split by ratio</td>
                    <td class="item-share">${tipShareText}</td>
                `;
                container.appendChild(tipRow);
            }
            // Add total row
            const totals = subtotals.map((s, i) => s + taxShares[i] + tipShares[i]);
            const grandTotal = totals.reduce((a, b) => a + b, 0);
            const totalText = people.map((p, idx) => `${p.name}: $${totals[idx].toFixed(2)}`).join('<br/>');
            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
                <td class="item-name">TOTAL</td>
                <td class="item-cost">$${grandTotal.toFixed(2)}</td>
                <td class="item-payer"></td>
                <td class="item-share">${totalText}</td>
            `;
            container.appendChild(totalRow);
        }
        
        function exportToCSV() {
            let csv = `Item,Cost,Expense To,${people.map(p => p.name + ' Share').join(',')}` + '\n';
            const items = document.querySelectorAll('.input-row');
            items.forEach(item => {
                const name = item.querySelector('.item-name').value || 'Unnamed Item';
                const cost = parseFloat(item.querySelector('.item-cost').value) || 0;
                const payer = item.querySelector('.item-payer').value;
                let shares = people.map(() => 0);
                if (people.find(p => p.id === payer)) {
                    shares[people.findIndex(p => p.id === payer)] = cost;
                } else if (payer === 'Split') {
                    const evenShare = Math.floor((cost / people.length) * 100) / 100;
                    let distributed = evenShare * people.length;
                    let remainder = Math.round((cost - distributed) * 100) / 100;
                    for (let i = 0; i < people.length; i++) shares[i] = evenShare;
                    if (remainder !== 0) shares[people.length - 1] += remainder;
                } else if (payer === 'Custom') {
                    const row = item;
                    const customCell = row.querySelector('.custom-split-cell');
                    if (customCell) {
                        const typeSel = customCell.querySelector('.custom-split-type');
                        const customInputs = customCell.querySelectorAll('input');
                        if (typeSel && customInputs.length === people.length) {
                            const type = typeSel.value;
                            let vals = Array.from(customInputs).map(inp => parseFloat(inp.value) || 0);
                            if (type === 'percent') {
                                const percentSum = vals.reduce((a, b) => a + b, 0);
                                if (Math.abs(percentSum - 100) < 0.01) {
                                    for (let i = 0; i < people.length; i++) shares[i] = cost * (vals[i] / 100);
                                }
                            } else if (type === 'dollar') {
                                const dollarSum = vals.reduce((a, b) => a + b, 0);
                                if (Math.abs(dollarSum - cost) < 0.01) {
                                    for (let i = 0; i < people.length; i++) shares[i] = vals[i];
                                }
                            }
                        }
                    }
                }
                csv += `"${name}",${cost.toFixed(2)},"${people.find(p => p.id === payer)?.name || payer}",${shares.map(s => s.toFixed(2)).join(',')}` + '\n';
            });
            // Add tax row
            const taxAmount = parseFloat(document.getElementById('tax-amount').value) || 0;
            const subtotals = people.map((_, idx) => parseFloat(document.getElementById(`person${idx+1}-subtotal`)?.textContent?.replace('$', '') || 0));
            const totalSubtotal = subtotals.reduce((a, b) => a + b, 0);
            let taxShares = people.map(() => 0);
            if (totalSubtotal > 0) {
                let distributed = 0;
                for (let i = 0; i < people.length - 1; i++) {
                    taxShares[i] = Math.round((subtotals[i] / totalSubtotal * taxAmount) * 100) / 100;
                    distributed += taxShares[i];
                }
                taxShares[people.length - 1] = Math.round((taxAmount - distributed) * 100) / 100;
            }
            csv += `"Tax",${taxAmount.toFixed(2)},"Split by ratio",${taxShares.map(s => s.toFixed(2)).join(',')}` + '\n';
            // Add tip row
            const tipAmount = parseFloat(document.getElementById('tip-amount').value) || 0;
            let tipShares = people.map(() => 0);
            if (totalSubtotal > 0) {
                let distributed = 0;
                for (let i = 0; i < people.length - 1; i++) {
                    tipShares[i] = Math.round((subtotals[i] / totalSubtotal * tipAmount) * 100) / 100;
                    distributed += tipShares[i];
                }
                tipShares[people.length - 1] = Math.round((tipAmount - distributed) * 100) / 100;
            }
            csv += `"Tip",${tipAmount.toFixed(2)},"Split by ratio",${tipShares.map(s => s.toFixed(2)).join(',')}` + '\n';
            // Add totals
            csv += '\n';
            const totals = people.map((_, idx) => parseFloat(document.getElementById(`person${idx+1}-total`)?.textContent?.replace('$', '') || 0));
            csv += `"TOTALS",,,${totals.map(t => '"$' + t.toFixed(2) + '"').join(',')}` + '\n';
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'grocery_split.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Enable Enter key to add another item
        function addEnterKeyListener(row) {
            const inputs = row.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addItem();
                        // Focus the first input of the new row
                        const allRows = document.querySelectorAll('.input-row');
                        const lastRow = allRows[allRows.length - 1];
                        if (lastRow) {
                            const firstInput = lastRow.querySelector('input');
                            if (firstInput) firstInput.focus();
                        }
                    }
                });
            });
        }

        function handlePayerChange(select) {
            const row = select.closest('tr');
            const customCell = row.querySelector('.custom-split-cell');
            if (select.value === 'Custom') {
                // Generate custom split inputs for all people
                let customInputsHtml = people.map((p, idx) =>
                    `<input type="number" class="custom-split-person" data-person-idx="${idx}" data-person-id="${p.id}" placeholder="${p.name} % or $" min="0" style="width:${Math.max(100/people.length-2,20)}%; display:inline-block; margin-right:2px;" onchange="calculateSummary()" oninput="validateCustomSplit(this)">`
                ).join('');
                customInputsHtml += `<select class="custom-split-type" style="width:100%; margin-top:2px;" onchange="calculateSummary(); validateCustomSplit(this)">
                    <option value="percent">%</option>
                    <option value="dollar">$</option>
                </select>`;
                customCell.innerHTML = customInputsHtml;
                // Immediately call updatePersonNames to capture the new state for preservation
                updatePersonNames();
            } else {
                customCell.innerHTML = '';
            }
        }
        
        function validateCustomSplit(input) {
            const row = input.closest('tr');
            const customCell = row.querySelector('.custom-split-cell');
            const typeSel = customCell.querySelector('.custom-split-type');
            const customInputs = customCell.querySelectorAll('.custom-split-person');
            const cost = parseFloat(row.querySelector('.item-cost').value) || 0;
            if (typeSel && customInputs.length === people.length && cost > 0) {
                const type = typeSel.value;
                let values = Array.from(customInputs).map(inp => parseFloat(inp.value) || 0);
                let isValid = false;
                if (type === 'percent') {
                    isValid = Math.abs(values.reduce((a, b) => a + b, 0) - 100) < 0.01;
                } else if (type === 'dollar') {
                    isValid = Math.abs(values.reduce((a, b) => a + b, 0) - cost) < 0.01;
                }
                customInputs.forEach(inp => {
                    inp.style.borderColor = isValid ? '#ddd' : 'red';
                });
            }
        }

        function resetPayerBorder(select) {
            select.style.borderColor = '#ddd';
        }

        function generatePersonId() {
            return (window.crypto && window.crypto.getRandomValues)
                ? ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                    (c ^ window.crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16))
                : 'p' + Date.now() + Math.floor(Math.random()*10000);
        }

        // On page load, set people array to the values of the first two inputs if present
        window.addEventListener('DOMContentLoaded', () => {
            rebuildPeopleConfigList(); // Build the people config list from the initial people array
            updatePersonNames(); // Doesn't do much unless there are more than 2 people on initial load
            addItem(); // Add a single item row on initialization
        });
    </script>
</body>
</html>